services:
  # =============================================================================
  # Nginx (리버스 프록시) - 프로덕션과 동일한 라우팅 테스트
  # =============================================================================
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.local.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - savant_api
      - savant_web
    networks:
      - savant_network

  # =============================================================================
  # API Server (FastAPI)
  # =============================================================================
  savant_api:
    build:
      context: .
      dockerfile: Dockerfile_api
    container_name: savant_api
    env_file:
      - .env
    environment:
      - SERVER_PORT=${SERVER_PORT:-8000}
      - DB_HOST=savant_db
      - REDIS_HOST=savant_redis
    ports:
      - "127.0.0.1:${SERVER_PORT:-8000}:${SERVER_PORT:-8000}"
    command: ["sh", "-c", "uv run uvicorn main_api:app --host 0.0.0.0 --port ${SERVER_PORT:-8000}"]
    depends_on:
      - savant_db
      - savant_redis
    networks:
      - savant_network

  savant_db:
    image: postgres:16
    container_name: savant_db
    ports:
      - "127.0.0.1:5432:5432"
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
      - DB_READONLY_USER=${DB_READONLY_USER}
      - DB_READONLY_PASSWORD=${DB_READONLY_PASSWORD}
      - TEST_DB_NAME=${TEST_DB_NAME}
    volumes:
      - savant_db:/var/lib/postgresql/data
      - ./init_sqls:/docker-entrypoint-initdb.d
    networks:
      - savant_network

  savant_redis:
    container_name: savant_redis
    image: redis:8.0-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - savant_redis_data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    networks:
      - savant_network

  savant_web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: savant_web
    env_file:
      - .env
    environment:
      # 클라이언트 사이드: 브라우저에서 nginx를 통해 API 호출
      - NEXT_PUBLIC_API_URL=http://localhost
      # 서버 사이드 (ISR): Docker 네트워크 내에서 nginx를 통해 API 호출
      - BACKEND_URL=http://nginx
      # NextAuth.js 설정
      - NEXTAUTH_URL=http://localhost
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      # Google OAuth
      - GOOGLE_CLIENT_ID=${OAUTH_GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${OAUTH_GOOGLE_CLIENT_SECRET}
    # nginx를 통해 접근하므로 직접 포트 노출은 개발 디버깅용
    ports:
      - "127.0.0.1:3001:3001"
    command: ["npm", "run", "dev", "--", "-p", "3001"]
    depends_on:
      - savant_api
    networks:
      - savant_network

networks:
  savant_network:
    driver: bridge

volumes:
  savant_db:
  savant_redis_data: